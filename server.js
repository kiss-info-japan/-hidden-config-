require('dotenv').config();
const express = require('express');
const cors = require('cors');
const fetch = require('node-fetch');

const app = express();
const PORT = 3000;

app.use(cors());
app.use(express.json());

const MISTRAL_API_KEY = process.env.MISTRAL_API_KEY;
if (!MISTRAL_API_KEY) {
    console.error("🚨 MISTRAL_API_KEY が設定されていません！.env ファイルを確認してください。");
    process.exit(1);
}

const MISTRAL_API_URL = "https://api.mistral.ai/v1/chat/completions";

// ユーザーごとの診断データを保存
const userSessions = {};

// 📌 診断テスト開始API
app.post('/start-diagnosis', async (req, res) => {
    const { userId } = req.body;
    if (!userId) {
        return res.status(400).json({ error: "userId が必要です。" });
    }

    try {
        const questionPrompt = `
        宗教観を診断するための質問を15個考えてください。  
        - 自由回答形式の質問にすること。  
        - 難しい専門用語を使わず、日常的な言葉を使う。  
        - 直感的に答えられるようにする。  
        - 「信仰」や「宗教」という言葉を使わなくても、自分の価値観を考えながら答えられる質問にする。  
        - 具体的な場面をイメージしやすいようにする。  
        - Yes/No ではなく、自由に考えを述べられる形式にする。  
        `;

        const response = await fetch(MISTRAL_API_URL, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${MISTRAL_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'mistral-medium',
                messages: [{ role: 'user', content: questionPrompt }]
            })
        });

        const data = await response.json();
        if (!response.ok) {
            console.error("🚨 Mistral API エラー:", data);
            throw new Error(data.error?.message || 'Mistral API error');
        }

        // 質問リストを取得
        const questions = data.choices[0].message.content
            .split('\n')
            .map(q => q.replace(/^\d+\.\s*/, '').trim())
            .filter(q => q.length > 0);

        if (questions.length < 15) {
            return res.status(500).json({ error: "質問の生成に失敗しました。" });
        }

        // ユーザーのセッションを作成
        userSessions[userId] = { questions, answers: [] };

        // 最初の質問を送信
        res.json({ reply: `最初の質問です\n${questions[0]}` });

    } catch (error) {
        console.error("🚨 サーバーエラー:", error);
        res.status(500).json({ error: error.message });
    }
});

// 📌 診断テストの進行API
app.post('/chat', async (req, res) => {
    try {
        const { userId, message } = req.body;
        if (!userId || !message) {
            return res.status(400).json({ error: "userIdとmessageが必要です。" });
        }

        // 診断セッションがない場合
        if (!userSessions[userId]) {
            return res.status(400).json({ error: "診断がまだ開始されていません。" });
        }

        const session = userSessions[userId];
        session.answers.push(message);

        // 次の質問を送る
        const nextQuestionIndex = session.answers.length;
        if (nextQuestionIndex < session.questions.length) {
            return res.json({
                reply: `${nextQuestionIndex + 1}番目の質問:\n${session.questions[nextQuestionIndex]}`
            });
        }

       // 📌 診断ロジック（Mistral AI に依頼）
       const diagnosisPrompt = 
       `以下の質問と回答に基づき、ユーザーの行動原理を支える「Hidden Config」を解析し、最適な「Installed Religion」を表示してください。
       
       【診断ルール】
       - 以下のリストから最も適したものを1つ選択してください。
       - 必ず以下のリスト内の宗教のみを1つ選択してください。
       - リスト外の言葉（例：「無教」など）を生成しないこと。
•	キリスト教 
o	概要: 紀元1世紀にイエス・キリストの教えに基づいて成立。神の愛と救済を中心とし、聖書を聖典とする。カトリック、プロテスタント、正教会などの宗派がある。
o	信仰・教義: イエス・キリストを神の子として信じ、彼の死と復活によって罪からの救済が得られるとする。
•	イスラム教 
o	概要: 7世紀にムハンマドによって開かれた宗教。唯一神アッラーへの信仰、コーランの教え、五行（信仰告白、礼拝、断食、喜捨、巡礼）を重視。
o	信仰・教義: アッラーのみを唯一神とし、ムハンマドは最後の預言者とされる。シャリーア（イスラム法）に従う。
•	仏教 
o	概要: 紀元前5世紀頃にインドで釈迦によって開かれた。苦しみの原因を解明し、解脱を目指す。上座部仏教、大乗仏教、チベット仏教などがある。
o	信仰・教義: 四諦（苦・集・滅・道）と八正道を重視し、煩悩を断ち切ることで輪廻から解脱できると考える。
•	ヒンドゥー教 
o	概要: インドの伝統的な宗教で、多神教的要素を持つ。輪廻転生とカルマの思想を基盤にし、ヴェーダ聖典を重視する。
o	信仰・教義: ブラフマー（創造）、ヴィシュヌ（維持）、シヴァ（破壊）などの神々を信仰し、カルマによって来世が決まると考える。
•	ユダヤ教 
o	概要: 紀元前10世紀頃にヘブライ人によって形成。唯一神ヤハウェを信仰し、律法（トーラー）を厳守。キリスト教・イスラム教の源流。
o	信仰・教義: 神とイスラエルの民との契約を重視し、613の戒律を守ることが求められる。メシア（救済者）の到来を待つ。
•	シク教 
o	概要: 15世紀にインドのグル・ナーナクによって創始。ヒンドゥー教とイスラム教の要素を融合。
o	信仰・教義: 唯一神ワーヘグルを信仰し、平等と労働、奉仕を重視する。
•	道教 
o	概要: 紀元前4世紀頃に中国で成立。老子・荘子の思想をもとに、自然との調和や不老不死を目指す。気の流れ（道）を重視。
o	信仰・教義: 道（タオ）に従い、無為自然の生き方を実践することで調和を得る。
•	神道 
o	概要: 日本固有の宗教で、自然崇拝と祖先信仰を中心とする。八百万の神を信じ、神社での祭祀が特徴。
o	信仰・教義: 神々との調和を大切にし、穢れを祓うことで清浄な状態を保つ。
•	ゾロアスター教 
o	概要: 紀元前6世紀頃にペルシャでゾロアスター（ザラスシュトラ）が創始。光と闇の二元論を特徴とする。
o	信仰・教義: 唯一神アフラ・マズダーを崇拝し、善悪の戦いの中で善を選ぶことが求められる。火を神聖視する。
•	シャーマニズム 
o	概要: 世界各地の先住民の宗教形態。精霊信仰や祖霊崇拝を中心とし、シャーマン（呪術師）が霊的な力を媒介。
o	信仰・教義: 精霊との交流を通じて病気の治癒や未来の予見を行う。
•	サタニズム 
o	概要: 19世紀以降に発展した、キリスト教の「悪魔崇拝」の概念に由来する思想や実践の総称。
o	信仰・教義: 伝統的な悪魔崇拝だけでなく、人間の自由意志を重視する哲学的サタニズムも存在する。
•	クリスチャン・サイエンス 
o	概要: 19世紀にアメリカでメアリー・ベーカー・エディによって創始。病気を精神的に治癒できると考える。
o	信仰・教義: 物質世界の現実性を否定し、神の力による癒しを重視する。
•	ムスリム・シーア派 
o	概要: イスラム教の一派で、アリーをムハンマドの正統な後継者とする。
o	信仰・教義: イマーム（指導者）を重視し、ムハンマドの血統を継ぐ者が宗教的権威を持つとする。
•	ムスリム・スンニ派 
o	概要: イスラム教最大の宗派で、ムハンマドの後継者は共同体の選択によるとする。
o	信仰・教義: コーランとハディース（預言者の言行録）を重視し、ウラマー（宗教学者）の指導を尊重する。
•	モルモン教（末日聖徒イエス・キリスト教会） 
o	概要: 19世紀にアメリカでジョセフ・スミスが創始。キリスト教の一派とされるが独自の教義を持つ。
o	信仰・教義: 『モルモン書』を聖典とし、神の啓示が現在も続いていると信じる。
•	アフリカ伝統宗教 
o	概要: アフリカ各地の先住民の信仰。精霊崇拝、祖先崇拝、呪術などを含む。
o	信仰・教義: 祖霊とのつながりを重視し、自然界の精霊や神々を崇拝する。
•	カバラ 
o	概要: ユダヤ教神秘主義の一形態。宇宙の神秘や神との関係を解釈する。
o	信仰・教義: 「セフィロトの樹」に象徴される宇宙構造を研究し、神との合一を目指す。
•	ヴィシュヌ教 
o	概要: ヒンドゥー教の一派で、ヴィシュヌ神を最高神とする。
o	信仰・教義: クリシュナやラーマなどの化身を信仰し、献身（バクティ）を重視する。
•	ジャイナ教 
o	概要: 紀元前6世紀頃にインドで成立。暴力を否定し、徹底した不殺生を実践する。
o	信仰・教義: カルマを否定し、厳格な戒律を守ることで解脱を目指す。
•	ローマカトリック 
o	概要: キリスト教の最大宗派で、バチカン市国に総本山を持つ。
o	信仰・教義: 教皇の権威を認め、聖母マリア崇敬を重視する。
•	プロテスタント 
o	概要: 16世紀の宗教改革でカトリックから分離したキリスト教の一派。
o	信仰・教義: 「聖書のみ」を基本とし、教会の権威よりも個々の信仰を重視する。
•	アングリカン教（英国国教会） 
o	概要: 16世紀にイングランドで成立し、カトリックとプロテスタントの中間的立場をとる。
o	信仰・教義: 司教制を持ちつつも、聖書と個人の良心を尊重する。
•	メソポタミア宗教 
o	概要: 古代メソポタミア文明（シュメール、アッカド、バビロニア）の信仰。
o	信仰・教義: 多神教で、エンリル、イシュタル、マルドゥクなどの神々を崇拝。
•	エジプト神殿信仰 
o	概要: 古代エジプトの宗教。太陽神ラーやオシリス神を中心とする多神教。
o	信仰・教義: 死後の世界を重視し、ミイラ作りや来世での復活を信じる。
•	アステカ宗教 
o	概要: アステカ文明の宗教で、多神教の要素を持つ。
o	信仰・教義: 太陽神ウィツィロポチトリへの生贄を重要視。
•	インカ宗教 
o	概要: インカ帝国の宗教で、太陽神インティを最高神とする。
o	信仰・教義: 王を神の子として崇め、祖先崇拝を行う。
ネイティブ・アメリカン宗教 
o	概要: 北米先住民の伝統的信仰。精霊や自然崇拝が中心。
o	信仰・教義: 大地や動物に宿る精霊を尊び、部族ごとに独自の神話や儀式を持つ。
•	ヴードゥー教 
o	概要: 西アフリカ起源で、ハイチやルイジアナなどに広がった民間信仰。
o	信仰・教義: ロアと呼ばれる精霊を崇拝し、儀式を通じて交流する。
•	カオダイ教 
o	概要: 20世紀にベトナムで成立した新宗教。諸宗教の要素を融合。
o	信仰・教義: 仏教・道教・キリスト教・儒教などを統合し、神の啓示を重視。
•	シク教 
o	概要: 15世紀にインドで成立。ヒンドゥー教とイスラム教の影響を受けた。
o	信仰・教義: 一神教であり、グル・ナーナクを始祖とし、平等と勤労を重視する。
•	マンダ教 
o	概要: イラクやイランの少数派宗教で、グノーシス主義的な要素を持つ。
o	信仰・教義: 水を神聖視し、ヤハウェを否定。洗礼を重視する。
•	バハイ教 
o	概要: 19世紀にペルシャ（イラン）で生まれた宗教。世界平和と統一を重視。
o	信仰・教義: 神は唯一であり、すべての宗教の真理を認める。
•	フィンランド異教（ウコ信仰） 
o	概要: フィンランドの伝統宗教で、多神教的な要素を持つ。
o	信仰・教義: 雷神ウコを中心に、自然崇拝と精霊信仰を行う。
•	スラヴ異教 
o	概要: スラヴ民族の古代信仰。ペルン神などを崇拝。
o	信仰・教義: 自然崇拝と祖先崇拝が特徴で、キリスト教以前の信仰として残る。
•	ノース神話（北欧異教） 
o	概要: 北欧バイキング時代の宗教で、多神教。
o	信仰・教義: オーディン、トールなどを崇拝し、戦士の死後ヴァルハラに行くと信じる。
•	ケルト異教 
o	概要: 古代ケルト人の信仰で、ドルイド僧が宗教的指導者。
o	信仰・教義: 自然崇拝と多神教、死後の世界観を重視。
•	アニミズム 
o	概要: 世界各地に存在する、精霊崇拝を中心とした宗教形態。
o	信仰・教義: すべての物に霊が宿ると考え、自然との調和を重視。
•	ヒレリズム（古代ギリシャ宗教） 
o	概要: 古代ギリシャの神々を信仰する宗教。
o	信仰・教義: ゼウスやアポロンなどの神々が人間に影響を与えると考える。
•	ローマ神話宗教 
o	概要: 古代ローマの多神教信仰。ギリシャ神話の影響を強く受ける。
o	信仰・教義: 神々を崇拝し、皇帝崇拝も行われた。
•	ズールー宗教 
o	概要: アフリカのズールー族の伝統信仰。
o	信仰・教義: 祖霊崇拝と精霊信仰が中心で、シャーマン的な存在が重要視される。
•	オーストラリア先住民宗教（ドリーミング） 
o	概要: アボリジニの信仰。神話「ドリーミング」を中心とする。
o	信仰・教義: 祖先の精霊が世界を形作ったとされ、土地と精霊とのつながりを重視。
•	ハワイ先住民宗教 
o	概要: ハワイのポリネシア系宗教。ペレなどの神々を信仰。
o	信仰・教義: 自然崇拝が強く、フラダンスも宗教的な意味を持つ。
•	シャイプー信仰（南米先住民） 
o	概要: アマゾン先住民の宗教。
o	信仰・教義: 精霊や自然との交流を重視し、幻覚植物を用いた儀式を行う。
•	アステカ宗教（補足） 
o	概要: アステカ帝国の宗教で、多神教的。
o	信仰・教義: 太陽の運行を保つために生贄が必要とされた。
•	インカ宗教（補足） 
o	概要: インカ帝国の公式宗教で、太陽神インティが最高神。
o	信仰・教義: 皇帝は神の化身とされ、自然崇拝も重視。

       
       質問と回答:
        ${session.questions.map((q, i) => `Q${i + 1}: ${q}\nA${i + 1}: ${session.answers[i]}`).join("\n")}
       
       【出力フォーマット】
       - **診断結果:** 「Installed Religion: ○○」
       - **診断レポート:**
         - ○○がどのような信念体系であるかを日本語で簡潔に説明してください。
         - なぜユーザーのHidden Configに適合するのかを論理的に説明してください。
         - その宗教の歴史的背景および社会文化的影響を提示してください。
       - **ユーザーの行動傾向分析:**
         - 回答内容から導き出せるユーザーの行動原理、思想的傾向を記述してください。
         - 「信仰」「秩序」「自由」「合理」「霊性」などの軸で分類し、どの特性が強いか示してください。
       
       【出力例】
       --------------------------------------------
       System Analysis Complete
       
       Installed Religion: ○○
       
       診断レポート:
       ○○は「△△」を根幹とする信念体系であり、個人の○○に対する認識を□□と定義する。ユーザーの回答はこの概念と高い整合性を示している。
       
       歴史的に○○は□□の中で発展し、特に△△の思想に影響を与えた。これにより社会的には□□の要素を持ち、現代では△△の価値観を反映する。
       
       行動傾向分析:
       - **支配的な思考軸:** 秩序 / 自由 / 霊性 / 合理 / 信仰
       - **判明した傾向:**
         - 「〇〇〇」への関心が高い
         - 「□□□」を重視する傾向
         - 「△△△」に対する認識が明確
       
       Hidden Config Update Completed.`;

        const response = await fetch(MISTRAL_API_URL, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${MISTRAL_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'mistral-medium',
                messages: [{ role: 'user', content: diagnosisPrompt }]
            })
        });

        const data = await response.json();
        if (!response.ok) {
            console.error("🚨 Mistral API エラー:", data);
            throw new Error(data.error?.message || 'Mistral API error');
        }

        const diagnosisResult = data.choices[0].message.content.trim();

        // 結果を返す
        return res.json({ result: diagnosisResult });

    } catch (error) {
        console.error("🚨 サーバーエラー:", error);
        res.status(500).json({ error: error.message });
    }
});

app.listen(PORT, () => {
    console.log(`🚀 Server is running on http://localhost:${PORT}`);
});
